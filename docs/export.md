# Export

> `src/lib/export.ts` — Client-side XLSX and PDF report generation.

Both export functions run in the browser (not server-side). They access `window` and `document` directly.

## XLSX Export

### `exportToXLSX(scanName, data)`

Single scan export.

**Workbook structure:** One worksheet named after the scan (truncated to 31 chars, special chars replaced).

**Columns:**

| Header | Key | Width |
|--------|-----|-------|
| Rank | `rank` | 10 |
| Business Name | `name` | 40 |
| Rating | `rating` | 10 |
| Reviews | `reviews` | 10 |
| Address | `address` | 60 |
| URL | `url` | 80 |
| Point Lat | `lat` | 15 |
| Point Lng | `lng` | 15 |

Each grid point's `topResults` JSON is parsed and all businesses are added as rows. A single 5x5 grid scan with 20 results per point produces 500 rows.

**Output:** Downloads `{scanName}_results.xlsx` via Blob URL.

### `exportAllScansToXLSX(scans)`

Multi-scan export.

**Workbook structure:**
1. "All Scans Summary" sheet — one row per scan with keyword, status, grid size, radius, dates, coordinates
2. Per-scan sheets — same format as single export, one sheet per scan

**Output:** Downloads `GeoRanker_All_Scans_{YYYY-MM-DD}.xlsx`.

## PDF Export

### `exportToPDF(scanName, data, scan?)`

3-page visual report using jsPDF + jspdf-autotable.

### Color Scheme

| Name | RGB | Usage |
|------|-----|-------|
| Primary | (37, 99, 235) | Headers, branding, table headers |
| Success | (34, 197, 94) | Good metrics (rank ≤5, visibility ≥70%) |
| Warning | (245, 158, 11) | Medium metrics (rank 5-10, visibility 40-70%) |
| Danger | (239, 68, 68) | Poor metrics (rank >10, visibility <40%) |
| Gray | (107, 114, 128) | Labels, secondary text |
| Dark | (17, 24, 39) | Body text |

### Page 1: Title + Executive Summary

**Header:** Full-width primary blue banner with "GEORANKER" title and "Local SEO Intelligence Report" subtitle.

**Report title:** `Keyword: "{scanName}"`

**Scan details box:** Light gray rounded rect with:
- Generated date, grid points count
- Grid size, radius, center coordinates (if scan data provided)

**Target business banner:** Primary blue rounded rect with business name (if tracking).

**Executive summary:** 4 metric boxes in a row:

| Box | Value | Color Logic |
|-----|-------|-------------|
| Grid Points | Total count | Always primary blue |
| Avg Rank | `#X.X` or N/A | ≤5 green, ≤10 amber, >10 red |
| Top 3 Rate | `X%` | ≥50% green, ≥25% amber, <25% red |
| Visibility | `X%` | ≥70% green, ≥40% amber, <40% red |

### Metrics Calculation

```typescript
function calculateMetrics(results, businessName?) {
    totalPoints = results.length
    rankedPoints = count where rank is truthy
    top3Points = count where rank ≤ 3
    top10Points = count where rank ≤ 10
    avgRank = sum(ranks) / rankedPoints
    top3Percentage = (top3Points / totalPoints) × 100
    visibilityScore = (rankedPoints / totalPoints) × 100
}
```

### Page 2: Top Competitors

**Header:** Primary blue banner with "Top Competitors Analysis" title.

**Top 10 competitors** by average rank (via `aggregateCompetitors()`):

Each competitor rendered as a card row:
- Rank badge (colored: 1-3 green, 4-7 amber, 8-10 red)
- Business name (truncated to 35 chars)
- Stats: avg rank, best rank, appearances, rating, review count

**Market Insights box:** Light gray rounded rect with 3 bullet points:
- Market leader name and appearance count
- Competition level assessment based on top-3 visibility
- Unique competitor count

### Competitor Aggregation

```typescript
function aggregateCompetitors(results) {
    // Parse each point's topResults JSON
    // Group by business name (lowercase)
    // Track ranks[], latest rating, reviews, address
    // Compute: appearances, avgRank, bestRank
    // Sort by avgRank ascending
}
```

### Page 3: Grid Point Breakdown

**Header:** Primary blue banner with "Grid Point Breakdown" title and point count.

**Table** (jspdf-autotable):

| Column | Width | Content |
|--------|-------|---------|
| Point | 20 | "Point N" (first row of each point only) |
| Coordinates | 35 | "lat, lng" (first row only) |
| Rank | 15 | "#N" (centered) |
| Business Name | 60 | Truncated to 30 chars |
| Rating | 20 | "★4.5" (centered) |
| Reviews | 20 | Count (centered) |

Shows top 3 businesses per grid point. Limited to 60 rows to prevent overflow.

**Table styling:**
- Header: primary blue background, white text, bold, 8pt
- Body: 7pt, 2px cell padding
- Alternating rows: light gray (248, 250, 252)

### Footer

Light gray bar at page bottom:
- Left: "Generated by GeoRanker - Local SEO Intelligence Grid"
- Right: Report ID (timestamp in base-36, uppercased)

### Output

Downloads `{scanName}_GeoRanker_Report.pdf` via `doc.save()`.

## Review Analysis Export

The review analysis page (`/reviews/[id]`) has its own export methods (not in `export.ts`):

### CSV Export

Client-side generation in the page component:
- Section 1: Individual reviews (reviewer, rating, text, sentiment, fake score, date, response)
- Section 2: Metrics summary (health score, NPS, response rate, trust score, etc.)

Downloads via Blob URL.

### PDF Export

Opens a new browser tab with a full HTML document (inline styles), then calls `window.print()` for the browser's native print-to-PDF.
